<!DOCTYPE html>
<html>
	<head>
		<script type="text/javascript" src="js/jquery-1.9.1.min.js"></script>
		<script type="text/javascript" src="js/underscore-min.js"></script>
		<script type="text/javascript" src="js/backbone-min.js"></script>
		
		<script type="text/javascript">
			$(document).ready(
				function(){
					myInviteeCollection = new InviteeCollection();
					mySeedCollection = new SeedCollection();
					mySeedCollection.fetch();

					pr = new FeedProcessor(myInviteeCollection, mySeedCollection);
					

					invitee = new InviteeView({
						el:"#invitee",
						collection:myInviteeCollection,
						process:pr
					});
					
					seed = new SeedView({
						el:"#seed",
						collection:mySeedCollection
					});
				});

			/////////////////////////////////////////////////////////////////////////////////Invitee Data 

			var inviteeArray = {};
			
			InviteeView = Backbone.View.extend({
				initialize: function(){
					//this.collection.sync('read',this);
					this._p = this.options.process
					this.collection.fetch();
					this.listenTo(this.collection,'reset',this.onUpdate)
					console.log (this.collection);
				},
				onUpdate:function(){
					//how to reference  information within the feedProcessor
					console.log (this.collection);
//					console.log (this._p.get('handle',5));
					//this._p.get('invitee',2);
					_.each(this.collection.models, function(e,i){

						if (this._p.get('currentSeeder', i) == null){
							console.log(this._p.get('handle',i));
							var result = false;
							this._p.get('findNextChain', i);
						}
					},this);
				}
			});
			
			/////////////////////////////////////////////////////////////////////////////////Seed Data
			SeedView = Backbone.View.extend({
				initialize: function(){
					//this.collection.fetch();
					this.listenTo(this.collection,'reset',this.onUpdate)
					console.log (this.collection);
				},
				onUpdate:function(){
					console.log (this.collection);

					_.each(this.collection.models,function(e,i){
						/*var seedHandle = e.attributes.seeder;
						seedHandle = seedHandle.replace(/@/g,'');
						seedHandle = seedHandle.replace(/\s+/g, '');
					
						this.$el.append("<h2>#"+seedHandle+"</h2>");
						this.$el.append('<img src="https://api.twitter.com/1/users/profile_image?screen_name='+seedHandle+'&size=bigger" /><br/>');*/
					},this);
				}
			});

			var InviteeModel = Backbone.Model.extend({
				url: 'http://localhost:8090/data/invitee.json'				
			});
			var InviteeCollection = Backbone.Collection.extend({
				model: InviteeModel,
				url: 'http://localhost:8090/data/invitee.json'
    	});
			
			var SeedModel = Backbone.Model.extend();
			var SeedCollection = Backbone.Collection.extend({
				model: SeedModel,
				url: 'http://localhost:8090/data/seed.json'
    	});

    	FeedProcessor = function(inviteeCollection, seedCollection){
    		this.inviteeCollection = inviteeCollection;
    		this.seedCollection = seedCollection;
    		console.log(this.inviteeCollection.models);
    		console.log(this.seedCollection.models);
    	}

    	FeedProcessor.prototype = {
    		get:function(what,arg){
    			return this['_'+what](arg);
    		},
    		_allEntries:function(arg){
    			return this.inviteeCollection.models;
    		},
    		_entry:function(arg){
    			return this.inviteeCollection.models[arg];
    		}, 
    		_accepted:function(arg){
    			return this.inviteeCollection.models[arg].attributes.accepted;
    		},
    		_currentSeeder:function(arg){
    			return this.inviteeCollection.models[arg].attributes.current_seed;
    		},
    		_event:function(arg){
    			return this.inviteeCollection.models[arg].attributes.event;
    		}, 
    		_handle:function(arg){
    			return this.inviteeCollection.models[arg].attributes.handle;
    		},
    		_id:function(arg){
    			return this.inviteeCollection.models[arg].attributes.id;
    		},
    		_inviter:function(arg){
    			return this.inviteeCollection.models[arg].attributes.inviter;
    		},
    		_isSeeder:function(arg){
    			return this.inviteeCollection.models[arg].attributes.seeder;
    		},
    		_seedId:function(arg){
    			return this.seedCollection.models[arg].attributes.id;
    		},
    		_seedMaxSeederChain:function(arg){
    			return this.seedCollection.models[arg].attributes.max_seeder_chain;
    		},
    		_seederHandle:function(arg){
    			return this.seedCollection.models[arg].attributes.seeder;
    		}, 
    		_findNextChain:function(arg){
    			//Return 1 if invitee found, run function again;
    			//Return 0 if no invitee found 
    			for (var j=0; j < this.inviteeCollection.models.length; j++){
						if (this.inviteeCollection.models[j].attributes.inviter != null){
							if(this.inviteeCollection.models[arg].attributes.handle == this.inviteeCollection.models[j].attributes.inviter){
								console.log(j+":"+this.inviteeCollection.models[j].attributes.handle);
								matchFound = true;
								arg = j;
							}								
						}
					}

    		}
    	}

		</script>
	</head>
	<body>
		<div id="invitee">
			<ul></ul>
		</div>
		<div id="seed">
			<ul></ul>
		</div>
	</body>
</html>